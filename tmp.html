<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clearance Dashboard</title>
    <link rel="stylesheet" href="http://testserver/static/css/style.css">
    
</head>
<body>
    <header class="site-header">
        <div class="brand">
            <a href="/" class="brand-link">
                <img src="http://testserver/static/img/gloorbot.png" alt="GloorBot logo" class="brand-logo" loading="lazy">
                <div class="brand-text">
                    <span class="brand-name">GloorBot</span>
                    <span class="brand-tagline">WA &amp; OR Lowe's Clearance</span>
                </div>
            </a>
        </div>
        <nav class="nav-links" aria-label="Primary navigation">
            <a href="/" class="nav-link active">All Clearance</a>
            <a href="/new-today?state=WA" class="nav-link">New Today WA</a>
            <a href="/new-today?state=OR" class="nav-link">New Today OR</a>
            <a href="/cheapskater" class="nav-link">Saved Deals</a>
        </nav>
    </header>
    <main class="site-main">
        
<section class="dashboard">
    <div class="dashboard-header">
        <div class="heading-group">
            <h1>All Clearance</h1>
            <p class="subtitle">Real-time Lowe's building-material clearance for Washington and Oregon.</p>
        </div>
        
        
        
        
        
        <div class="toolbar-actions">
            <a class="btn" href="/export.xlsx?scope=all">Export to Excel</a>
            <a class="btn secondary" href="/api/clearance?scope=all" target="_blank" rel="noopener">View JSON</a>
        </div>
    </div>

    <form method="get" action="/" class="filters" role="search">
        <div class="filter-group">
            <label for="state" class="filter-label">State</label>
            <select id="state" name="state" onchange="this.form.submit()">
                
                <option value="" selected>ALL</option>
                
                <option value="WA">WA</option>
                
                <option value="OR">OR</option>
                
            </select>
        </div>
        <div class="filter-group">
            <label for="category" class="filter-label">Category</label>
            <select id="category" name="category" onchange="this.form.submit()">
                <option value="">All Categories</option>
                
                <option value="Drywall">Drywall</option>
                
                <option value="Electrical">Electrical</option>
                
                <option value="Flooring">Flooring</option>
                
                <option value="Hardware">Hardware</option>
                
                <option value="Insulation">Insulation</option>
                
                <option value="Lumber">Lumber</option>
                
                <option value="Paint">Paint</option>
                
                <option value="Plumbing">Plumbing</option>
                
                <option value="Roofing">Roofing</option>
                
                <option value="Tools">Tools</option>
                
            </select>
        </div>
        <div class="filter-group">
            <label for="time_window" class="filter-label">Date Added</label>
            <select id="time_window" name="time_window" onchange="this.form.submit()">
                
                <option value="all" selected>All Dates</option>
                
                <option value="1h">Last 1 hour</option>
                
                <option value="12h">Last 12 hours</option>
                
                <option value="24h">Last 24 hours</option>
                
                <option value="3d">Last 3 days</option>
                
                <option value="1w">Last 1 week</option>
                
                <option value="1m">Last 1 month</option>
                
            </select>
        </div>
        <div class="filter-group">
            <label for="sort_order" class="filter-label">Sort</label>
            <select id="sort_order" name="sort_order" onchange="this.form.submit()">
                
                <option value="newest" selected>Newest first</option>
                
                <option value="alpha_asc">Title A → Z</option>
                
                <option value="alpha_desc">Title Z → A</option>
                
                <option value="price_low">Price: Low → High</option>
                
                <option value="price_high">Price: High → Low</option>
                
            </select>
        </div>
        <div class="filter-group">
            <label for="discount_filter" class="filter-label">Discount</label>
            <select id="discount_filter" name="discount_filter">
                
                <option value="all" selected>All Discounts</option>
                
                <option value="60">60%+</option>
                
                <option value="75">75%+</option>
                
                <option value="90">90%+</option>
                
                <option value="custom">Custom Range…</option>
                
            </select>
            <div class="custom-range" data-target="discount" hidden>
                <label for="discount_min" class="sr-only">Min discount %</label>
                <input type="number" id="discount_min" name="discount_min" min="0" max="100" placeholder="Min %" value="">
                <label for="discount_max" class="sr-only">Max discount %</label>
                <input type="number" id="discount_max" name="discount_max" min="0" max="100" placeholder="Max %" value="">
            </div>
        </div>
        <div class="filter-group">
            <label for="stock_filter" class="filter-label">Stock</label>
            <select id="stock_filter" name="stock_filter">
                
                <option value="all" selected>Any Stock</option>
                
                <option value="1">1+ Stock</option>
                
                <option value="2">2+ Stock</option>
                
                <option value="3">3+ Stock</option>
                
                <option value="4">4+ Stock</option>
                
                <option value="5">5+ Stock</option>
                
                <option value="custom">Custom Range…</option>
                
            </select>
            <div class="custom-range" data-target="stock" hidden>
                <label for="stock_min" class="sr-only">Min stock</label>
                <input type="number" id="stock_min" name="stock_min" min="0" placeholder="Min" value="">
                <label for="stock_max" class="sr-only">Max stock</label>
                <input type="number" id="stock_max" name="stock_max" min="0" placeholder="Max" value="">
            </div>
        </div>
        <div class="filter-group search-field">
            <label for="search" class="filter-label">Search</label>
            <input type="search" id="search" placeholder="SKU, store, keyword…" autocomplete="off" spellcheck="false">
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn tertiary">Apply Filters</button>
        </div>
    </form>
    <div class="saved-deals-hint">
        <strong>Plan your run:</strong>
        Click <em>Save deal</em> next to any store to build a pickup list, then open the
        <a href="/cheapskater">Saved Deals</a> page to review everything grouped by store.
    </div>
    <div class="saved-toast" id="saved-toast" role="status" aria-live="polite" hidden></div>

    <p class="last-updated">Last updated: Nov 17, 2025 07:10 PM </p>

    
    <div id="cards-grid" class="cards-grid" aria-live="polite" data-initial-count="3">
        
        
        
            
        
        
        
        
        
        
        
        
        
            
            
                
            
        
        <article class="product-card" data-keywords="beta ladder sku-beta">
            <div class="product-card__header">
                <div class="product-card__image">
                    
                    <div class="image-placeholder">No Image</div>
                    
                </div>
                <div class="product-card__body">
                    <h2 class="product-title">
                        
                        <a href="https://example.com/sku-beta?storeNumber=store-sort-2" target="_blank" rel="noopener">Beta Ladder</a>
                        
                    </h2>
                    <div class="product-meta">
                        <span class="pill category">Tools</span>
                        <span class="pill sku">SKU sku-beta</span>
                        <span class="pill locations">1 store</span>
                    </div>
                    <div class="product-pricing">
                        <div class="price-current">
                            
                                $35.00
                            
                        </div>
                        
                        <div class="price-was">
                            Regular $52.50
                        </div>
                        
                        
                        <div class="price-spread">Spread $0.00</div>
                        
                        
                        <div class="price-savings">
                            Save $17.50
                        </div>
                        
                        
                        <span class="discount-badge">
                            
                                25% off
                            
                        </span>
                        
                        <div class="store-count-note">
                            1 store with this price
                        </div>
                    </div>
                    <div class="product-timeline">
                        
                        <span>Added Nov 17 PT (0d ago)</span>
                        
                        
                        <span>Updated Nov 17 04:10 PM PT</span>
                        
                    </div>
                </div>
            </div>
            <div class="store-list">
                
                
                
                
                
                
                
                
                    
                
                <div class="store-row">
                    <div class="store-details">
                        <div class="store-name" title="Seattle, WA, 98102 • Store #store-sort-2">Sort Store 2 – Seattle</div>
                        <div class="store-location">
                            WA 98102
                        </div>
                    </div>
                    <div class="store-pricing">
                        
                        <div class="price">$35.00</div>
                        
                        
                        <div class="was-price">Was $52.50</div>
                        
                        
                        <div class="store-savings">Save $17.50</div>
                        
                        
                    </div>
                    <div class="store-meta">
                        <span class="availability-badge availability-in-stock">In stock</span>
                        
                        <span class="stock-pill">Stock: 5</span>
                        
                        
                        <span class="timestamp">Updated Nov 17 04:10 PM PT</span>
                        
                    </div>
                    <div class="store-action">
                        <a class="btn small" href="https://example.com/sku-beta?storeNumber=store-sort-2" target="_blank" rel="noopener">View Store Deal</a>
                        
                        <button
                            type="button"
                            class="btn tertiary small js-save-deal"
                            data-store="store-sort-2"
                            data-sku="sku-beta"
                        >
                            Save deal
                        </button>
                        
                    </div>
                </div>
                
            </div>
        </article>
        
        
        
            
        
        
        
        
        
        
        
        
        
            
            
                
            
        
        <article class="product-card" data-keywords="alpha shingles sku-alpha">
            <div class="product-card__header">
                <div class="product-card__image">
                    
                    <div class="image-placeholder">No Image</div>
                    
                </div>
                <div class="product-card__body">
                    <h2 class="product-title">
                        
                        <a href="https://example.com/sku-alpha?storeNumber=store-sort-0" target="_blank" rel="noopener">Alpha Shingles</a>
                        
                    </h2>
                    <div class="product-meta">
                        <span class="pill category">Tools</span>
                        <span class="pill sku">SKU sku-alpha</span>
                        <span class="pill locations">1 store</span>
                    </div>
                    <div class="product-pricing">
                        <div class="price-current">
                            
                                $25.00
                            
                        </div>
                        
                        <div class="price-was">
                            Regular $37.50
                        </div>
                        
                        
                        <div class="price-spread">Spread $0.00</div>
                        
                        
                        <div class="price-savings">
                            Save $12.50
                        </div>
                        
                        
                        <span class="discount-badge">
                            
                                25% off
                            
                        </span>
                        
                        <div class="store-count-note">
                            1 store with this price
                        </div>
                    </div>
                    <div class="product-timeline">
                        
                        <span>Added Nov 17 PT (0d ago)</span>
                        
                        
                        <span>Updated Nov 17 03:40 PM PT</span>
                        
                    </div>
                </div>
            </div>
            <div class="store-list">
                
                
                
                
                
                
                
                
                    
                
                <div class="store-row">
                    <div class="store-details">
                        <div class="store-name" title="Seattle, WA, 98100 • Store #store-sort-0">Sort Store 0 – Seattle</div>
                        <div class="store-location">
                            WA 98100
                        </div>
                    </div>
                    <div class="store-pricing">
                        
                        <div class="price">$25.00</div>
                        
                        
                        <div class="was-price">Was $37.50</div>
                        
                        
                        <div class="store-savings">Save $12.50</div>
                        
                        
                    </div>
                    <div class="store-meta">
                        <span class="availability-badge availability-in-stock">In stock</span>
                        
                        <span class="stock-pill">Stock: 5</span>
                        
                        
                        <span class="timestamp">Updated Nov 17 03:40 PM PT</span>
                        
                    </div>
                    <div class="store-action">
                        <a class="btn small" href="https://example.com/sku-alpha?storeNumber=store-sort-0" target="_blank" rel="noopener">View Store Deal</a>
                        
                        <button
                            type="button"
                            class="btn tertiary small js-save-deal"
                            data-store="store-sort-0"
                            data-sku="sku-alpha"
                        >
                            Save deal
                        </button>
                        
                    </div>
                </div>
                
            </div>
        </article>
        
        
        
            
        
        
        
        
        
        
        
        
        
            
            
                
            
        
        <article class="product-card" data-keywords="gamma drill sku-gamma">
            <div class="product-card__header">
                <div class="product-card__image">
                    
                    <div class="image-placeholder">No Image</div>
                    
                </div>
                <div class="product-card__body">
                    <h2 class="product-title">
                        
                        <a href="https://example.com/sku-gamma?storeNumber=store-sort-1" target="_blank" rel="noopener">Gamma Drill</a>
                        
                    </h2>
                    <div class="product-meta">
                        <span class="pill category">Tools</span>
                        <span class="pill sku">SKU sku-gamma</span>
                        <span class="pill locations">1 store</span>
                    </div>
                    <div class="product-pricing">
                        <div class="price-current">
                            
                                $15.00
                            
                        </div>
                        
                        <div class="price-was">
                            Regular $22.50
                        </div>
                        
                        
                        <div class="price-spread">Spread $0.00</div>
                        
                        
                        <div class="price-savings">
                            Save $7.50
                        </div>
                        
                        
                        <span class="discount-badge">
                            
                                25% off
                            
                        </span>
                        
                        <div class="store-count-note">
                            1 store with this price
                        </div>
                    </div>
                    <div class="product-timeline">
                        
                        <span>Added Nov 17 PT (0d ago)</span>
                        
                        
                        <span>Updated Nov 17 01:40 PM PT</span>
                        
                    </div>
                </div>
            </div>
            <div class="store-list">
                
                
                
                
                
                
                
                
                    
                
                <div class="store-row">
                    <div class="store-details">
                        <div class="store-name" title="Seattle, WA, 98101 • Store #store-sort-1">Sort Store 1 – Seattle</div>
                        <div class="store-location">
                            WA 98101
                        </div>
                    </div>
                    <div class="store-pricing">
                        
                        <div class="price">$15.00</div>
                        
                        
                        <div class="was-price">Was $22.50</div>
                        
                        
                        <div class="store-savings">Save $7.50</div>
                        
                        
                    </div>
                    <div class="store-meta">
                        <span class="availability-badge availability-in-stock">In stock</span>
                        
                        <span class="stock-pill">Stock: 5</span>
                        
                        
                        <span class="timestamp">Updated Nov 17 01:40 PM PT</span>
                        
                    </div>
                    <div class="store-action">
                        <a class="btn small" href="https://example.com/sku-gamma?storeNumber=store-sort-1" target="_blank" rel="noopener">View Store Deal</a>
                        
                        <button
                            type="button"
                            class="btn tertiary small js-save-deal"
                            data-store="store-sort-1"
                            data-sku="sku-gamma"
                        >
                            Save deal
                        </button>
                        
                    </div>
                </div>
                
            </div>
        </article>
        
    </div>
    <div id="scroll-sentinel" aria-hidden="true"></div>
    <p class="no-results" id="no-results-message" hidden>No clearance items match your filters. Try another search.</p>
    <script id="group-data" type="application/json">[{"sku": "sku-beta", "title": "Beta Ladder", "category": "Tools", "image_url": null, "min_price": 35.0, "max_price": 35.0, "min_price_was": 52.5, "max_price_was": 52.5, "min_pct_off": 0.25, "max_pct_off": 0.25, "price_spread": 0.0, "discount_spread": 0.0, "min_stock_estimate": 5, "max_stock_estimate": 5, "min_savings": 17.5, "max_savings": 17.5, "locations": 1, "added_at": "2025-11-17T19:10:47.781406", "last_seen": "2025-11-17T19:10:47.781406", "days_since_added": 0, "best_product_url": "https://example.com/sku-beta?storeNumber=store-sort-2", "stores": [{"history_id": 3, "retailer": "lowes", "store_id": "store-sort-2", "store_name": "Sort Store 2", "store_city": "Seattle", "store_state": "WA", "store_zip": "98102", "sku": "sku-beta", "title": "Beta Ladder", "category": "Tools", "price": 35.0, "price_was": 52.5, "pct_off": 0.25, "availability": "In stock", "product_url": "https://example.com/sku-beta", "store_product_url": "https://example.com/sku-beta?storeNumber=store-sort-2", "image_url": null, "clearance": true, "first_seen": "2025-11-17T19:10:47.781406", "price_started_at": "2025-11-17T19:10:47.781406", "updated_at": "2025-11-17T19:10:47.781406", "prev_price": null, "prev_price_was": null, "prev_pct_off": null, "prev_updated_at": null, "prev_clearance": null, "store_label": "Sort Store 2 – Seattle", "store_tooltip": "Seattle, WA, 98102 • Store #store-sort-2", "stock_estimate": 5, "stock_label": "5 units available", "days_since_added": 0}]}, {"sku": "sku-alpha", "title": "Alpha Shingles", "category": "Tools", "image_url": null, "min_price": 25.0, "max_price": 25.0, "min_price_was": 37.5, "max_price_was": 37.5, "min_pct_off": 0.25, "max_pct_off": 0.25, "price_spread": 0.0, "discount_spread": 0.0, "min_stock_estimate": 5, "max_stock_estimate": 5, "min_savings": 12.5, "max_savings": 12.5, "locations": 1, "added_at": "2025-11-17T18:40:47.781406", "last_seen": "2025-11-17T18:40:47.781406", "days_since_added": 0, "best_product_url": "https://example.com/sku-alpha?storeNumber=store-sort-0", "stores": [{"history_id": 1, "retailer": "lowes", "store_id": "store-sort-0", "store_name": "Sort Store 0", "store_city": "Seattle", "store_state": "WA", "store_zip": "98100", "sku": "sku-alpha", "title": "Alpha Shingles", "category": "Tools", "price": 25.0, "price_was": 37.5, "pct_off": 0.25, "availability": "In stock", "product_url": "https://example.com/sku-alpha", "store_product_url": "https://example.com/sku-alpha?storeNumber=store-sort-0", "image_url": null, "clearance": true, "first_seen": "2025-11-17T18:40:47.781406", "price_started_at": "2025-11-17T18:40:47.781406", "updated_at": "2025-11-17T18:40:47.781406", "prev_price": null, "prev_price_was": null, "prev_pct_off": null, "prev_updated_at": null, "prev_clearance": null, "store_label": "Sort Store 0 – Seattle", "store_tooltip": "Seattle, WA, 98100 • Store #store-sort-0", "stock_estimate": 5, "stock_label": "5 units available", "days_since_added": 0}]}, {"sku": "sku-gamma", "title": "Gamma Drill", "category": "Tools", "image_url": null, "min_price": 15.0, "max_price": 15.0, "min_price_was": 22.5, "max_price_was": 22.5, "min_pct_off": 0.25, "max_pct_off": 0.25, "price_spread": 0.0, "discount_spread": 0.0, "min_stock_estimate": 5, "max_stock_estimate": 5, "min_savings": 7.5, "max_savings": 7.5, "locations": 1, "added_at": "2025-11-17T16:40:47.781406", "last_seen": "2025-11-17T16:40:47.781406", "days_since_added": 0, "best_product_url": "https://example.com/sku-gamma?storeNumber=store-sort-1", "stores": [{"history_id": 2, "retailer": "lowes", "store_id": "store-sort-1", "store_name": "Sort Store 1", "store_city": "Seattle", "store_state": "WA", "store_zip": "98101", "sku": "sku-gamma", "title": "Gamma Drill", "category": "Tools", "price": 15.0, "price_was": 22.5, "pct_off": 0.25, "availability": "In stock", "product_url": "https://example.com/sku-gamma", "store_product_url": "https://example.com/sku-gamma?storeNumber=store-sort-1", "image_url": null, "clearance": true, "first_seen": "2025-11-17T16:40:47.781406", "price_started_at": "2025-11-17T16:40:47.781406", "updated_at": "2025-11-17T16:40:47.781406", "prev_price": null, "prev_price_was": null, "prev_pct_off": null, "prev_updated_at": null, "prev_clearance": null, "store_label": "Sort Store 1 – Seattle", "store_tooltip": "Seattle, WA, 98101 • Store #store-sort-1", "stock_estimate": 5, "stock_label": "5 units available", "days_since_added": 0}]}]</script>
</section>

    </main>
    <footer class="site-footer">
        <p>Tracking Lowe's building-material clearance for Washington &amp; Oregon.</p>
    </footer>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
  const dataEl = document.getElementById('group-data');
  const grid = document.getElementById('cards-grid');
  const sentinel = document.getElementById('scroll-sentinel');
  const searchInput = document.getElementById('search');
  const noResultsMessage = document.getElementById('no-results-message');
  const discountSelect = document.getElementById('discount_filter');
  const stockSelect = document.getElementById('stock_filter');
  const discountCustom = document.querySelector('.custom-range[data-target="discount"]');
  const stockCustom = document.querySelector('.custom-range[data-target="stock"]');
  const BATCH_SIZE = 30;
  const toastEl = document.getElementById('saved-toast');
  let toastTimerId;

  const showToast = (message) => {
    if (!toastEl) {
      return;
    }
    toastEl.textContent = message;
    toastEl.hidden = false;
    toastEl.classList.add('visible');
    if (toastTimerId) {
      clearTimeout(toastTimerId);
    }
    toastTimerId = setTimeout(() => {
      toastEl.classList.remove('visible');
      toastEl.hidden = true;
    }, 3200);
  };

  if (!grid || !dataEl) {
    return;
  }

  const toggleCustomRange = (selectEl, container) => {
    if (!selectEl || !container) return;
    container.hidden = selectEl.value !== 'custom';
  };

  toggleCustomRange(discountSelect, discountCustom);
  toggleCustomRange(stockSelect, stockCustom);

  discountSelect?.addEventListener('change', () => {
    toggleCustomRange(discountSelect, discountCustom);
  });

  stockSelect?.addEventListener('change', () => {
    toggleCustomRange(stockSelect, stockCustom);
  });

  let allGroups = [];
  try {
    allGroups = JSON.parse(dataEl.textContent || '[]');
  } catch (err) {
    console.error('Failed to parse group data', err);
    return;
  }

  const formatCurrency = (value) => {
    if (value === null || value === undefined) return '';
    return `$${Number(value).toFixed(2)}`;
  };

  const formatDiscount = (group) => {
    if (group.min_pct_off === null || group.min_pct_off === undefined) return '';
    const minPct = Math.floor(group.min_pct_off * 100);
    if (group.max_pct_off !== null && group.max_pct_off !== undefined && group.max_pct_off !== group.min_pct_off) {
      const maxPct = Math.floor(group.max_pct_off * 100);
      return `${minPct}%–${maxPct}% off`;
    }
    return `${minPct}% off`;
  };

  const formatDate = (value, { showTime = true } = {}) => {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    const opts = showTime
      ? { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }
      : { month: 'short', day: '2-digit' };
    return date.toLocaleString(undefined, opts);
  };

  const formatRangeText = (minValue, maxValue, prefix) => {
    if (minValue === null || minValue === undefined) return '';
    const base = `${prefix} ${formatCurrency(minValue)}`;
    if (maxValue !== null && maxValue !== undefined && maxValue !== minValue) {
      return `${base} – ${formatCurrency(maxValue)}`;
    }
    return base;
  };

  const availabilityClass = (text) => {
    if (!text) return '';
    return `availability-${text.toLowerCase().replace(/\s+/g, '-')}`;
  };

  const buildStoreRows = (stores = [], defaultSku = '') => {
    return stores
      .map((store) => {
        const availability = store.availability || 'Unknown';
        const availabilityClassName = availabilityClass(availability);
        const storeName = store.store_label || store.store_name || (store.store_zip ? `Lowe's ${store.store_zip}` : (store.store_id ? `Store ${store.store_id}` : 'Unknown store'));
        const storeLink = store.store_product_url || store.product_url || '#';
        const storeTip = store.store_tooltip || `${store.store_city || ''}, ${store.store_state || ''} ${store.store_zip || ''}`;
        const savings = store.price_was !== null && store.price_was !== undefined && store.price !== null && store.price !== undefined
          ? Math.max(store.price_was - store.price, 0)
          : null;
        const stockText = store.stock_estimate !== null && store.stock_estimate !== undefined
          ? `Stock: ${store.stock_estimate}`
          : (store.stock_label || '');
        const storeNumber = store.store_id || store.store_number || '';
        const sku = store.sku || defaultSku || '';
        const canSave = Boolean(storeNumber && sku);
        return `
        <div class="store-row">
          <div class="store-details">
            <div class="store-name" title="${storeTip}">${storeName}</div>
            <div class="store-location">
              ${(store.store_state || '')} ${store.store_zip || ''}
            </div>
          </div>
          <div class="store-pricing">
            <div class="price">${store.price !== null && store.price !== undefined ? formatCurrency(store.price) : '<span class="muted">–</span>'}</div>
            ${store.price_was ? `<div class="was-price">Was ${formatCurrency(store.price_was)}</div>` : ''}
            ${savings ? `<div class="store-savings">Save ${formatCurrency(savings)}</div>` : ''}
            ${store.prev_price ? `<div class="prev-price">Prev ${formatCurrency(store.prev_price)}</div>` : ''}
          </div>
          <div class="store-meta">
            <span class="availability-badge ${availabilityClassName}">${availability}</span>
            ${stockText ? `<span class="stock-pill">${stockText}</span>` : ''}
            ${store.updated_at ? `<span class="timestamp">Updated ${formatDate(store.updated_at)}</span>` : ''}
          </div>
          <div class="store-action">
            <a class="btn small" href="${storeLink}" target="_blank" rel="noopener">View Store Deal</a>
            ${canSave ? `<button type="button" class="btn tertiary small js-save-deal" data-store="${storeNumber}" data-sku="${sku}">Save deal</button>` : ''}
          </div>
        </div>`;
      })
      .join('');
  };

  const buildCard = (group) => {
    const keywords = [
      group.title || '',
      group.sku || '',
      ...(group.stores || []).map((store) => `${store.store_name || ''} ${store.store_state || ''} ${store.store_zip || ''} ${store.store_id || ''}`),
    ]
      .join(' ')
      .toLowerCase();
    const discount = formatDiscount(group);
    const priceCurrent = group.min_price !== null && group.min_price !== undefined
      ? `${formatCurrency(group.min_price)}${group.max_price !== null && group.max_price !== undefined && group.max_price !== group.min_price ? ` – ${formatCurrency(group.max_price)}` : ''}`
      : 'Price unavailable';
    const regularPrice = group.min_price_was !== null && group.min_price_was !== undefined
      ? formatRangeText(group.min_price_was, group.max_price_was, 'Regular')
      : '';
    const priceSpread = group.price_spread !== null && group.price_spread !== undefined && group.price_spread > 0
      ? `Spread ${formatCurrency(group.price_spread)}`
      : '';
    const savingsText = group.min_savings !== null && group.min_savings !== undefined
      ? `Save ${formatCurrency(group.min_savings)}${group.max_savings !== null && group.max_savings !== undefined && group.max_savings !== group.min_savings ? ` – ${formatCurrency(group.max_savings)}` : ''}`
      : '';
    const storeCountText = `${group.locations} store${group.locations === 1 ? '' : 's'} with this price`;
    const addedAgo = Number.isFinite(group.days_since_added)
      ? `${group.days_since_added}d ago`
      : '';

    const card = document.createElement('article');
    card.className = 'product-card';
    card.dataset.keywords = keywords;
    card.innerHTML = `
      <div class="product-card__header">
        <div class="product-card__image">
          ${
            group.image_url
              ? `<img src="${group.image_url}" alt="${group.title}" loading="lazy" width="70" height="70" style="max-width:70px;max-height:70px;width:auto;height:auto;object-fit:contain;">`
              : '<div class="image-placeholder">No Image</div>'
          }
        </div>
        <div class="product-card__body">
          <h2 class="product-title">
            ${
              group.best_product_url
                ? `<a href="${group.best_product_url}" target="_blank" rel="noopener">${group.title}</a>`
                : group.title
            }
          </h2>
          <div class="product-meta">
            <span class="pill category">${group.category || 'Uncategorised'}</span>
            <span class="pill sku">SKU ${group.sku}</span>
            <span class="pill locations">${group.locations} store${group.locations === 1 ? '' : 's'}</span>
          </div>
          <div class="product-pricing">
            <div class="price-current">${priceCurrent}</div>
            ${regularPrice ? `<div class="price-was">${regularPrice}</div>` : ''}
            ${priceSpread ? `<div class="price-spread">${priceSpread}</div>` : ''}
            ${savingsText ? `<div class="price-savings">${savingsText}</div>` : ''}
            ${discount ? `<span class="discount-badge">${discount}</span>` : ''}
            <div class="store-count-note">${storeCountText}</div>
          </div>
          <div class="product-timeline">
            ${group.added_at ? `<span>Added ${formatDate(group.added_at, { showTime: false })}${addedAgo ? ` (${addedAgo})` : ''}</span>` : ''}
            ${group.last_seen ? `<span>Updated ${formatDate(group.last_seen)}</span>` : ''}
          </div>
        </div>
      </div>
      <div class="store-list">
        ${buildStoreRows(group.stores, group.sku || '')}
      </div>
    `;
    return card;
  };

  let filteredGroups = allGroups.slice();
  let renderedCount = parseInt(grid.dataset.initialCount || '0', 10) || 0;

  const renderBatch = (reset = false) => {
    if (reset) {
      grid.innerHTML = '';
      renderedCount = 0;
    }
    if (renderedCount >= filteredGroups.length) {
      if (filteredGroups.length === 0) {
        noResultsMessage.hidden = false;
      } else {
        noResultsMessage.hidden = true;
      }
      return;
    }
    const slice = filteredGroups.slice(renderedCount, renderedCount + BATCH_SIZE);
    slice.forEach((group) => grid.appendChild(buildCard(group)));
    renderedCount += slice.length;

    if (filteredGroups.length === 0) {
      noResultsMessage.hidden = false;
    } else {
      noResultsMessage.hidden = true;
    }
  };

  const handleSearch = () => {
    const query = (searchInput?.value || '').trim().toLowerCase();
    if (!query) {
      filteredGroups = allGroups.slice();
    } else {
      filteredGroups = allGroups.filter((group) => {
        const keywords = [
          group.title || '',
          group.sku || '',
          ...(group.stores || []).map((store) => `${store.store_name || ''} ${store.store_state || ''} ${store.store_zip || ''}`),
        ]
          .join(' ')
          .toLowerCase();
        return keywords.includes(query);
      });
    }
    renderBatch(true);
  };

  const saveDealRequest = async (storeNumber, sku) => {
    const response = await fetch('/cheapskater/save-deal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ store_number: storeNumber, sku }),
    });
    if (!response.ok) {
      throw new Error(`Save failed with status ${response.status}`);
    }
    return response.json();
  };

  const handleSaveButton = async (button) => {
    const storeNumber = button.dataset.store;
    const sku = button.dataset.sku;
    if (!storeNumber || !sku) {
      return;
    }
    const originalText = button.textContent;
    button.disabled = true;
    try {
      const payload = await saveDealRequest(storeNumber, sku);
      if (!payload?.ok) {
        throw new Error('Invalid save response');
      }
      button.textContent = 'Saved';
      button.classList.add('saved');
      button.setAttribute('aria-pressed', 'true');
      showToast('Deal saved. Open Saved Deals to review your stops.');
    } catch (error) {
      console.error('Unable to save deal', error);
      button.textContent = 'Retry';
      setTimeout(() => {
        button.textContent = originalText;
      }, 1800);
    } finally {
      button.disabled = false;
    }
  };

  grid.addEventListener('click', (event) => {
    const saveButton = event.target.closest('.js-save-deal');
    if (!saveButton) {
      return;
    }
    event.preventDefault();
    handleSaveButton(saveButton);
  });

  const observer = new IntersectionObserver(
    (entries) => {
      const [entry] = entries;
      if (entry.isIntersecting) {
        renderBatch();
      }
    },
    {
      rootMargin: '200px',
    }
  );

  if (sentinel) {
    observer.observe(sentinel);
  }

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      handleSearch();
    });
  }

  if (renderedCount === 0) {
    renderBatch(true);
  }
});
</script>

</body>
</html>